trigger:
- none

pool:
  vmImage: 'ubuntu-latest'

steps:
- script: |
    git clone https://github.com/blackwhiteops/OSCAL.git oscal-tools
  displayName: 'Clone OSCAL Tools Repo'

- script: |
    git clone https://github.com/blackwhiteops/oscal-content.git oscal-content
  displayName: 'Clone OSCAL Content Repo'

- task: JavaToolInstaller@0
  inputs:
    versionSpec: '17'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'
  displayName: 'Install Java 17'

- script: |
    set -e
    echo "Downloading OSCAL CLI..."
    curl -LO https://github.com/usnistgov/OSCAL/releases/latest/download/oscal-cli.jar
    ls -lh oscal-cli.jar
  displayName: 'Download OSCAL CLI'

- script: |
    set -e
    echo "Converting XML files to JSON..."
    mkdir -p converted-oscal
    for file in $(find oscal-content/nist.gov -name "*.xml"); do
      base=$(basename "$file" .xml)
      echo "Converting $file to JSON"
      java -jar oscal-cli.jar convert --to json "$file" "converted-oscal/${base}.json" || echo "Conversion failed for $file" >> converted-oscal/conversion-failures.log
    done

    echo "Copying non-minified JSON files..."
    find oscal-content/nist.gov -name "*.json" ! -name "*-min.json" -exec cp {} converted-oscal/ \;
  displayName: 'Convert and Normalize OSCAL Files'

- script: |
    set -e
    echo "Starting OSCAL validation..."
    mkdir -p validation-results
    PASS_COUNT=0
    FAIL_COUNT=0

    for file in $(find converted-oscal -name "*.json"); do
      echo "Validating $file"
      if java -jar oscal-cli.jar validate "$file" > validation-results/$(basename "$file").log 2>&1; then
        echo "PASS: $file" >> validation-results/summary.log
        PASS_COUNT=$((PASS_COUNT+1))
      else
        echo "FAIL: $file" >> validation-results/summary.log
        FAIL_COUNT=$((FAIL_COUNT+1))
      fi
    done

    echo "Validation complete."
    echo "Summary: $PASS_COUNT passed, $FAIL_COUNT failed" | tee validation-results/final-summary.log

    if [ $FAIL_COUNT -gt 0 ]; then
      echo "Compliance check failed: $FAIL_COUNT files did not pass validation."
      exit 1
    fi
  displayName: 'Validate OSCAL Files (Strict Mode)'

- script: |
    set -e
    echo "Parsing uploaded compliance documents..."
    mkdir -p parsed-compliance
    for file in $(find $(System.DefaultWorkingDirectory)/compliance-uploads -type f \( -name "*.docx" -o -name "*.pdf" \)); do
      echo "Extracting text from $file"
      file_path="$file"
      echo "import os" > parse_doc.py
      echo "from pathlib import Path" >> parse_doc.py
      echo "import docx" >> parse_doc.py
      echo "import fitz  # PyMuPDF for PDFs" >> parse_doc.py
      echo "" >> parse_doc.py
      echo "file_path = os.environ.get('file_path', '')" >> parse_doc.py
      echo "output_path = 'parsed-compliance/' + Path(file_path).stem + '.txt'" >> parse_doc.py
      echo "" >> parse_doc.py
      echo "text = ''" >> parse_doc.py
      echo "if file_path.endswith('.docx'):" >> parse_doc.py
      echo "    doc = docx.Document(file_path)" >> parse_doc.py
      echo "    text = '\\n'.join([p.text for p in doc.paragraphs])" >> parse_doc.py
      echo "elif file_path.endswith('.pdf'):" >> parse_doc.py
      echo "    doc = fitz.open(file_path)" >> parse_doc.py
      echo "    text = '\\n'.join([page.get_text() for page in doc])" >> parse_doc.py
      echo "" >> parse_doc.py
      echo "os.makedirs('parsed-compliance', exist_ok=True)" >> parse_doc.py
      echo "with open(output_path, 'w') as f:" >> parse_doc.py
      echo "    f.write(text)" >> parse_doc.py
      python3 parse_doc.py
      rm parse_doc.py
    done
  displayName: 'Parse Compliance Docs (Word/PDF)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'validation-results'
    ArtifactName: 'oscal-validation-results'
    publishLocation: 'Container'
  displayName: 'Publish OSCAL Validation Results'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'parsed-compliance'
    ArtifactName: 'parsed-compliance-docs'
    publishLocation: 'Container'
  displayName: 'Publish Parsed Compliance Docs'